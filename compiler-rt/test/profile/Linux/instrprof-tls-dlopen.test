RUN: mkdir -p %t.d
RUN: %clang_profgen -fprofile-thread-local -fdata-sections -ffunction-sections -fuse-ld=gold -Wl,--gc-sections -o %t.d/func.shared -fPIC -shared %S/../Inputs/instrprof-tls-dlopen-func.c
RUN: %clang_profgen -fprofile-thread-local -fdata-sections -ffunction-sections -fuse-ld=gold -Wl,--gc-sections -o %t.d/func2.shared -fPIC -shared %S/../Inputs/instrprof-tls-dlopen-func2.c

RUN: %clang_profgen  -DDLOPEN_FUNC_DIR=\"%t.d\" -DDLOPEN_FLAGS="RTLD_LAZY" -fprofile-thread-local -fdata-sections -ffunction-sections -fuse-ld=gold -Wl,--gc-sections -o %t-tls -rpath %t.d %S/../Inputs/ %S/../Inputs/instrprof-tls-dlopen-main.c


RUN: %clang_profgen -fprofile-update=atomic -fdata-sections -ffunction-sections -fuse-ld=gold -Wl,--gc-sections -o %t.d/func_atomic.shared -fPIC -shared %S/../Inputs/instrprof-tls-dlopen-func.c
RUN: %clang_profgen -fdata-sections -ffunction-sections -fuse-ld=gold -Wl,--gc-sections -o %t.d/func2_atomic.shared -fPIC -shared %S/../Inputs/instrprof-tls-dlopen-func2.c

RUN: %clang_profgen  -DDLOPEN_FUNC_DIR=\"%t.d\" -DDLOPEN_FLAGS="RTLD_LAZY"  -fprofile-update=atomic -fdata-sections -ffunction-sections -fuse-ld=gold -Wl,--gc-sections -o %t-atomic -rpath %t.d %S/../Inputs/instrprof-tls-dlopen-main.c

RUN: env LLVM_PROFILE_FILE=%t-tls.profraw %run %t-tls
RUN: env LLVM_PROFILE_FILE=%t-atomic.profraw %run %t-atomic

RUN: llvm-profdata merge -o %t-tls.profdata %t-tls.profraw
RUN: llvm-profdata merge -o %t-atomic.profdata %t-atomic.profraw
RUN: %clang_profuse=%t-tls.profdata -o %t-func.tls.ll -S -emit-llvm %S/../Inputs/instrprof-tls-dlopen-func.c
RUN: %clang_profuse=%t-atomic.profdata -o %t-func.atomic.ll -S -emit-llvm %S/../Inputs/instrprof-tls-dlopen-func.c
RUN: diff %t-func.tls.ll %t-func.atomic.ll


RUN: llvm-profdata merge -o %t-tls.profdata %t-tls.profraw
RUN: llvm-profdata merge -o %t-atomic.profdata %t-atomic.profraw
RUN: %clang_profuse=%t-tls.profdata -o %t-func2.tls.ll -S -emit-llvm %S/../Inputs/instrprof-tls-dlopen-func2.c
RUN: %clang_profuse=%t-atomic.profdata -o %t-func2.atomic.ll -S -emit-llvm %S/../Inputs/instrprof-tls-dlopen-func2.c
RUN: diff %t-func2.tls.ll %t-func2.atomic.ll


RUN: llvm-profdata merge -o %t-tls.profdata %t-tls.profraw
RUN: llvm-profdata merge -o %t-atomic.profdata %t-atomic.profraw
RUN: %clang_profuse=%t-tls.profdata -o %t-func.tls.ll -S -emit-llvm %S/../Inputs/instrprof-tls-dlopen-func.c
RUN: %clang_profuse=%t-atomic.profdata -o %t-func.atomic.ll -S -emit-llvm %S/../Inputs/instrprof-tls-dlopen-func.c
RUN: diff %t-func.tls.ll %t-func.atomic.ll
